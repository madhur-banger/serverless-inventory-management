service: inventory-api

frameworkVersion: '3'

# =============================================================================
# PLUGINS
# =============================================================================
plugins:
  - serverless-esbuild
  - serverless-iam-roles-per-function
  - serverless-offline

# =============================================================================
# PROVIDER CONFIGURATION
# =============================================================================
provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: us-east-1
  
  # API Gateway configuration
  apiGateway:
    minimumCompressionSize: 1024
    shouldStartNameWithService: true
  
  # Environment variables for all functions
  environment:
    STAGE: ${self:provider.stage}
    TABLE_NAME: ${self:custom.tableName}
    LOG_LEVEL: ${self:custom.logLevel.${self:provider.stage}, 'info'}
    ORDER_QUEUE_URL: !Ref OrderQueue
    ORDER_TOPIC_ARN: !Ref OrderNotificationTopic
    CORS_ORIGIN: ${self:custom.corsOrigin.${self:provider.stage}}
  
  # Default Lambda settings
  memorySize: 256
  timeout: 10
  
  # X-Ray tracing
  tracing:
    apiGateway: true
    lambda: true
  
  # CloudWatch Logs retention
  logRetentionInDays: ${self:custom.logRetention.${self:provider.stage}, 7}

# =============================================================================
# CUSTOM VARIABLES
# =============================================================================
custom:
  # Table name
  tableName: ${self:service}-${self:provider.stage}-inventory
  
  # Stage-specific settings
  logLevel:
    dev: debug
    prod: info
  
  logRetention:
    dev: 7
    prod: 30
  
  corsOrigin:
    dev: '*'
    prod: ${env:FRONTEND_URL, '*'}
  
  deletionPolicy:
    dev: Delete
    prod: Retain
  
  pitrEnabled:
    dev: false
    prod: true
  
  adminEmail:
    dev: 'dev@example.com'
    prod: ${env:ADMIN_EMAIL, 'admin@example.com'}
  
  # esbuild configuration
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude:
      - '@aws-sdk/*'
    target: node20
    platform: node
    concurrency: 10
  
  # Serverless offline
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002

# =============================================================================
# FUNCTIONS
# =============================================================================
functions:
  # ---------------------------------------------------------------------------
  # HEALTH CHECK (No Auth)
  # ---------------------------------------------------------------------------
  health:
    handler: src/handlers/health.handler
    events:
      - http:
          path: /health
          method: get
          cors: true

  # ---------------------------------------------------------------------------
  # PRODUCT FUNCTIONS
  # ---------------------------------------------------------------------------
  createProduct:
    handler: src/handlers/products/create.handler
    events:
      - http:
          path: /products
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId: !Ref ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: !GetAtt InventoryTable.Arn

  getProduct:
    handler: src/handlers/products/get.handler
    events:
      - http:
          path: /products/{id}
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId: !Ref ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt InventoryTable.Arn

  listProducts:
    handler: src/handlers/products/list.handler
    events:
      - http:
          path: /products
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId: !Ref ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
          - dynamodb:Query
        Resource:
          - !GetAtt InventoryTable.Arn
          - !Sub '${InventoryTable.Arn}/index/*'

  updateProduct:
    handler: src/handlers/products/update.handler
    events:
      - http:
          path: /products/{id}
          method: put
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId: !Ref ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt InventoryTable.Arn

  deleteProduct:
    handler: src/handlers/products/delete.handler
    events:
      - http:
          path: /products/{id}
          method: delete
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId: !Ref ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:DeleteItem
        Resource: !GetAtt InventoryTable.Arn

  # ---------------------------------------------------------------------------
  # ORDER FUNCTIONS
  # ---------------------------------------------------------------------------
  createOrder:
    handler: src/handlers/orders/create.handler
    timeout: 15
    events:
      - http:
          path: /orders
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId: !Ref ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt InventoryTable.Arn
      - Effect: Allow
        Action:
          - sqs:SendMessage
        Resource: !GetAtt OrderQueue.Arn

  getOrder:
    handler: src/handlers/orders/get.handler
    events:
      - http:
          path: /orders/{id}
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId: !Ref ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt InventoryTable.Arn

  listOrders:
    handler: src/handlers/orders/list.handler
    events:
      - http:
          path: /orders
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId: !Ref ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - !GetAtt InventoryTable.Arn
          - !Sub '${InventoryTable.Arn}/index/*'

  # ---------------------------------------------------------------------------
  # SQS CONSUMERS (Background Workers)
  # ---------------------------------------------------------------------------
  processOrderNotification:
    handler: src/handlers/orders/processNotification.handler
    timeout: 30
    events:
      - sqs:
          arn: !GetAtt OrderQueue.Arn
          batchSize: 5
          functionResponseType: ReportBatchItemFailures
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt InventoryTable.Arn
      - Effect: Allow
        Action:
          - sns:Publish
        Resource: !Ref OrderNotificationTopic

  processOrderDLQ:
    handler: src/handlers/orders/processDLQ.handler
    timeout: 30
    events:
      - sqs:
          arn: !GetAtt OrderDLQ.Arn
          batchSize: 5
    # No special IAM needed, just logging

# =============================================================================
# RESOURCES (Import from separate files)
# =============================================================================
resources:
  - ${file(resources/dynamodb.yml)}
  - ${file(resources/cognito.yml)}
  - ${file(resources/sqs.yml)}
  - ${file(resources/sns.yml)}
  
  # Additional outputs
  - Outputs:
      ApiEndpoint:
        Description: API Gateway endpoint URL
        Value: !Sub 'https://${ApiGatewayRestApi}.execute-api.${self:provider.region}.amazonaws.com/${self:provider.stage}'
        Export:
          Name: ${self:service}-${self:provider.stage}-ApiEndpoint
      
      ServiceName:
        Description: Service name
        Value: ${self:service}
        Export:
          Name: ${self:service}-${self:provider.stage}-ServiceName