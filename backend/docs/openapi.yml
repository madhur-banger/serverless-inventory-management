# docs/openapi.yml
# OpenAPI 3.0 Specification for Inventory Management API

openapi: 3.0.3

info:
  title: Inventory Management API
  description: |
    A full-stack serverless REST API for inventory management with product catalog and order processing.
    
    ## Features
    - üîê **Authentication**: AWS Cognito JWT tokens
    - üì¶ **Products**: Full CRUD operations
    - üõí **Orders**: Purchase products with stock management
    - üìß **Notifications**: Email notifications via SQS/SNS
    
    ## Authentication
    All endpoints except `/health` require a valid JWT token in the Authorization header:

    Authorization: Bearer <your-jwt-token>

    
    Get your token by signing in via AWS Cognito.
  version: 1.0.0
  contact:
    name: Madhur
    email: madhur.cloudevops@gmail.com


servers:
  - url: https://{apiId}.execute-api.{region}.amazonaws.com/dev
    description: Development server
    variables:
      apiId:
        default: xxxxxxxxxx
        description: API Gateway ID
      region:
        default: us-east-1
        description: AWS Region
  - url: https://{apiId}.execute-api.{region}.amazonaws.com/prod
    description: Production server
    variables:
      apiId:
        default: xxxxxxxxxx
        description: API Gateway ID
      region:
        default: us-east-1
        description: AWS Region

tags:
  - name: Health
    description: Health check endpoint
  - name: Products
    description: Product management operations
  - name: Orders
    description: Order/purchase operations

# ==============================================================================
# SECURITY SCHEMES
# ==============================================================================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token from AWS Cognito. 
        Use `Authorization: Bearer <token>` header.

  # ============================================================================
  # SCHEMAS
  # ============================================================================
  schemas:
    # --------------------------------------------------------------------------
    # Product Schemas
    # --------------------------------------------------------------------------
    Product:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique product identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: Product name
          example: "Wireless Keyboard"
        description:
          type: string
          description: Product description
          example: "Ergonomic wireless keyboard with RGB backlight"
        category:
          $ref: '#/components/schemas/ProductCategory'
        price:
          type: integer
          description: Price in cents (e.g., 4999 = $49.99)
          example: 4999
        quantity:
          type: integer
          description: Stock quantity
          example: 100
        sku:
          type: string
          description: Stock Keeping Unit
          example: "WK-001-BLK"
        imageUrl:
          type: string
          format: uri
          description: Product image URL
          example: "https://example.com/images/keyboard.jpg"
        lowStock:
          type: boolean
          description: True if quantity <= 10
          example: false
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2024-01-15T10:30:00.000Z"
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2024-01-15T10:30:00.000Z"
      required:
        - id
        - name
        - description
        - category
        - price
        - quantity
        - sku
        - createdAt
        - updatedAt

    ProductCategory:
      type: string
      enum:
        - electronics
        - clothing
        - home
        - sports
        - books
        - toys
        - food
        - other
      description: Product category
      example: "electronics"

    CreateProductRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
          description: Product name
          example: "Wireless Keyboard"
        description:
          type: string
          minLength: 1
          maxLength: 2000
          description: Product description
          example: "Ergonomic wireless keyboard with RGB backlight"
        category:
          $ref: '#/components/schemas/ProductCategory'
        price:
          type: integer
          minimum: 1
          maximum: 100000000
          description: Price in cents
          example: 4999
        quantity:
          type: integer
          minimum: 0
          maximum: 1000000
          description: Stock quantity
          example: 100
        sku:
          type: string
          minLength: 1
          maxLength: 50
          pattern: "^[A-Za-z0-9-_]+$"
          description: Stock Keeping Unit (alphanumeric, hyphens, underscores)
          example: "WK-001-BLK"
        imageUrl:
          type: string
          format: uri
          maxLength: 500
          description: Product image URL (optional)
          example: "https://example.com/images/keyboard.jpg"
      required:
        - name
        - description
        - category
        - price
        - quantity
        - sku

    UpdateProductRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
          example: "Wireless Keyboard Pro"
        description:
          type: string
          minLength: 1
          maxLength: 2000
        category:
          $ref: '#/components/schemas/ProductCategory'
        price:
          type: integer
          minimum: 1
          maximum: 100000000
          example: 5999
        quantity:
          type: integer
          minimum: 0
          maximum: 1000000
          example: 150
        sku:
          type: string
          minLength: 1
          maxLength: 50
          pattern: "^[A-Za-z0-9-_]+$"
        imageUrl:
          type: string
          format: uri
          maxLength: 500
      minProperties: 1
      description: At least one field must be provided

    ProductList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Product'
        count:
          type: integer
          description: Number of items in current page
          example: 10
        nextToken:
          type: string
          description: Pagination token for next page (null if no more pages)
          example: "eyJQSyI6IlBST0RVQ1QjYWJjMTIzIn0="

    # --------------------------------------------------------------------------
    # Order Schemas
    # --------------------------------------------------------------------------
    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique order identifier
          example: "660e8400-e29b-41d4-a716-446655440000"
        userId:
          type: string
          description: User ID (from Cognito)
          example: "user-123"
        userEmail:
          type: string
          format: email
          description: User email
          example: "user@example.com"
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        totalAmount:
          type: integer
          description: Total amount in cents
          example: 9998
        status:
          $ref: '#/components/schemas/OrderStatus'
        createdAt:
          type: string
          format: date-time
          example: "2024-01-15T11:00:00.000Z"
        updatedAt:
          type: string
          format: date-time
          example: "2024-01-15T11:00:00.000Z"

    OrderItem:
      type: object
      properties:
        productId:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        productName:
          type: string
          example: "Wireless Keyboard"
        quantity:
          type: integer
          example: 2
        pricePerUnit:
          type: integer
          description: Price per unit in cents
          example: 4999
        totalPrice:
          type: integer
          description: Total price for this item in cents
          example: 9998

    OrderStatus:
      type: string
      enum:
        - PENDING
        - CONFIRMED
        - PROCESSING
        - SHIPPED
        - DELIVERED
        - CANCELLED
      description: Order status
      example: "CONFIRMED"

    CreateOrderRequest:
      type: object
      properties:
        productId:
          type: string
          format: uuid
          description: Product ID to purchase
          example: "550e8400-e29b-41d4-a716-446655440000"
        quantity:
          type: integer
          minimum: 1
          maximum: 100
          description: Quantity to purchase (max 100)
          example: 2
      required:
        - productId
        - quantity

    OrderList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Order'
        count:
          type: integer
          example: 5
        nextToken:
          type: string

    # --------------------------------------------------------------------------
    # Response Schemas
    # --------------------------------------------------------------------------
    ApiResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ResponseMeta:
      type: object
      properties:
        requestId:
          type: string
          example: "abc123-def456"
        timestamp:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00.000Z"

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "VALIDATION_ERROR"
            message:
              type: string
              example: "Validation failed"
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                    example: "price"
                  message:
                    type: string
                    example: "Price must be positive"
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: "healthy"
        service:
          type: string
          example: "inventory-api"
        version:
          type: string
          example: "1.0.0"
        stage:
          type: string
          example: "dev"
        timestamp:
          type: string
          format: date-time
        requestId:
          type: string

  # ============================================================================
  # COMMON RESPONSES
  # ============================================================================
  responses:
    BadRequest:
      description: Bad Request - Invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: "VALIDATION_ERROR"
              message: "Validation failed"
              details:
                - field: "price"
                  message: "Price must be positive"
            meta:
              requestId: "abc123"
              timestamp: "2024-01-15T10:30:00.000Z"

    Unauthorized:
      description: Unauthorized - Missing or invalid token
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Unauthorized"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: "NOT_FOUND"
              message: "Product with id '123' not found"
            meta:
              requestId: "abc123"
              timestamp: "2024-01-15T10:30:00.000Z"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: "INTERNAL_ERROR"
              message: "An unexpected error occurred"
            meta:
              requestId: "abc123"
              timestamp: "2024-01-15T10:30:00.000Z"

# ==============================================================================
# PATHS
# ==============================================================================
paths:
  # ----------------------------------------------------------------------------
  # HEALTH
  # ----------------------------------------------------------------------------
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the API. No authentication required.
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  # ----------------------------------------------------------------------------
  # PRODUCTS
  # ----------------------------------------------------------------------------
  /products:
    get:
      tags:
        - Products
      summary: List products
      description: |
        Returns a paginated list of products. Supports filtering by category and search.
      operationId: listProducts
      security:
        - bearerAuth: []
      parameters:
        - name: category
          in: query
          description: Filter by category
          schema:
            $ref: '#/components/schemas/ProductCategory'
        - name: search
          in: query
          description: Search in product name
          schema:
            type: string
            maxLength: 100
        - name: limit
          in: query
          description: Number of items per page (1-100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: nextToken
          in: query
          description: Pagination token from previous response
          schema:
            type: string
      responses:
        '200':
          description: List of products
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ProductList'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Products
      summary: Create product
      description: Creates a new product in the inventory.
      operationId: createProduct
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProductRequest'
      responses:
        '201':
          description: Product created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /products/{id}:
    get:
      tags:
        - Products
      summary: Get product
      description: Returns a single product by ID.
      operationId: getProduct
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Product found
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Products
      summary: Update product
      description: Updates an existing product. At least one field must be provided.
      operationId: updateProduct
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID (UUID)
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProductRequest'
      responses:
        '200':
          description: Product updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Products
      summary: Delete product
      description: Deletes a product from the inventory.
      operationId: deleteProduct
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Product deleted successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ----------------------------------------------------------------------------
  # ORDERS
  # ----------------------------------------------------------------------------
  /orders:
    get:
      tags:
        - Orders
      summary: List orders
      description: |
        Returns a paginated list of orders for the authenticated user.
        Users can only see their own orders.
      operationId: listOrders
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by order status
          schema:
            $ref: '#/components/schemas/OrderStatus'
        - name: limit
          in: query
          description: Number of items per page (1-50)
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - name: nextToken
          in: query
          description: Pagination token from previous response
          schema:
            type: string
      responses:
        '200':
          description: List of orders
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/OrderList'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Orders
      summary: Create order (Purchase)
      description: |
        Creates a new order (purchases a product).
        
        **Flow:**
        1. Validates product exists and has sufficient stock
        2. Atomically decreases product stock
        3. Creates order record with status `PENDING`
        4. Sends order to SQS for notification processing
        5. Background worker sends email notification via SNS
        6. Order status updated to `CONFIRMED`
      operationId: createOrder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '400':
          description: Bad Request (validation error or insufficient stock)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation:
                  summary: Validation Error
                  value:
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Validation failed"
                      details:
                        - field: "quantity"
                          message: "Quantity must be at least 1"
                    meta:
                      requestId: "abc123"
                      timestamp: "2024-01-15T10:30:00.000Z"
                insufficientStock:
                  summary: Insufficient Stock
                  value:
                    success: false
                    error:
                      code: "INSUFFICIENT_STOCK"
                      message: "Insufficient stock for product 'xyz'. Available: 5, Requested: 10"
                    meta:
                      requestId: "abc123"
                      timestamp: "2024-01-15T10:30:00.000Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /orders/{id}:
    get:
      tags:
        - Orders
      summary: Get order
      description: |
        Returns a single order by ID.
        Users can only access their own orders.
      operationId: getOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Order ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Order found
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'