name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'What to destroy'
        required: true
        type: choice
        options:
          - backend-dev
          - backend-prod
          - frontend-dev
          - frontend-prod
          - all-dev
          - all-prod
      confirm:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string

jobs:
  validate:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    if: inputs.confirm == 'DESTROY'
    outputs:
      stage: ${{ steps.parse.outputs.stage }}
      destroy_backend: ${{ steps.parse.outputs.destroy_backend }}
      destroy_frontend: ${{ steps.parse.outputs.destroy_frontend }}

    steps:
      - name: Parse target
        id: parse
        run: |
          TARGET="${{ inputs.target }}"
          
          if [[ "$TARGET" == *"-prod" ]]; then
            echo "stage=prod" >> $GITHUB_OUTPUT
          else
            echo "stage=dev" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$TARGET" == "backend-"* ]] || [[ "$TARGET" == "all-"* ]]; then
            echo "destroy_backend=true" >> $GITHUB_OUTPUT
          else
            echo "destroy_backend=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$TARGET" == "frontend-"* ]] || [[ "$TARGET" == "all-"* ]]; then
            echo "destroy_frontend=true" >> $GITHUB_OUTPUT
          else
            echo "destroy_frontend=false" >> $GITHUB_OUTPUT
          fi

  destroy-backend:
    name: Destroy Backend (${{ needs.validate.outputs.stage }})
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.destroy_backend == 'true'
    environment: ${{ needs.validate.outputs.stage == 'prod' && 'production' || 'development' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: backend

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Remove Backend Stack
        run: npx serverless remove --stage ${{ needs.validate.outputs.stage }} --verbose
        working-directory: backend

  destroy-frontend:
    name: Destroy Frontend (${{ needs.validate.outputs.stage }})
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.destroy_frontend == 'true'
    environment: ${{ needs.validate.outputs.stage == 'prod' && 'production' || 'development' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Remove Frontend Stack
        run: npx serverless remove --stage ${{ needs.validate.outputs.stage }} --verbose
        working-directory: frontend

  summary:
    name: Destruction Summary
    runs-on: ubuntu-latest
    needs: [validate, destroy-backend, destroy-frontend]
    if: always() && needs.validate.result == 'success'

    steps:
      - name: Summary
        run: |
          echo "## ⚠️ Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.validate.outputs.destroy_backend }}" == "true" ]]; then
            echo "| Backend | ${{ needs.validate.outputs.stage }} | ${{ needs.destroy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.validate.outputs.destroy_frontend }}" == "true" ]]; then
            echo "| Frontend | ${{ needs.validate.outputs.stage }} | ${{ needs.destroy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY